# 동시요청이들어온다면? - 멀티 쓰레드 편!

- 웹브라우저(클라이언트)에서 WAS로 요청이들어오면 서블릿 객체를 호출한다.

- **누가?? 누가 서블릿 객체 호출함?(서블릿 컨테이너의)**
- 바로 **쓰레드**이다. (프로세스내에 여러 쓰레드 있지?)

# 쓰레드

- 어플리케이션 코드를 하나하나 순차적으로 실행하는 것은 쓰레드이다.
- 자바 메인메서드를 처음 실행하면 main이라는 쓰레드가 실행되서 어플리케이션 코드를 순차적으로 실행한다.
- 쓰레드가 없다면 자바 어플 실행할수 없다.
- 쓰레드는 한번에 하나의 코드 라인만 수행할수있다.
- 만약 웹브라우저에서 동시요청이들어온다면 쓰레드를 추가로 생성할수있다.(자바는 멀티쓰레드 지원하닌까!?)

# 상황

## 하나의 요청이들어올때 - 쓰레드 하나 사용

- 웹브라우저가 WAS로 요청하면 WAS는 쓰레드 하나를 할당해서 서블릿 객체 호출하고 끝나면 쓰레드 반납한다.

## 여러 요청이 들어올때 - 쓰레드 하나 사용

- 웹브라우저 A에서 요청이들어옴. WAS에는 쓰레드 하나밖에없고 이 쓰레드로 서블릿 객체 호출해서 코드 한줄한줄 실행하는데 너무 오래걸림. 지연됨.
- 웹브라우저 B에서 또 WAS로 요청함. 근데 남는쓰레드가 없음(하나의 쓰레드는 웹브라우저 A의 요청처리하는중임.)
- 결국 웹브라우저 A, B의 요청둘다 터짐.

## 요청마다 쓰레드를 생성한다면 위 문제 해결할수있지않나?

- 웹브라우저 A가 WAS로 요청하면 WAS에서는 쓰레드 하나생성해서 A의 요청에대한 처리를함.(처리중)
- 이 때 웹브라우저 B가 WAS로 요청하면 또 새로운 쓰레드를 하나 생성해서 B의 요청에 대한 처리를함.
- 각 쓰레드가 요청에 대한 처리가 끝나면 다시 반납하고 각 웹브라우저한테 응답함.(병렬적으로 실행할수있겠다. - 쓰레드가 웹브라우저 요청때마다 새로 생성되므로)

### 요청마다 쓰레드 생성시의 장점

- 클라이언트의 동시요청을 처리할수있다.(쓰레드 하나만 사용했을땐 불가능했지..)
- 리소스(CPU나 메모리)가 허용될 때 까지 요청을 처리할수있다.
- 하나의 쓰레드가 요청에 대한 처리가 지연되어도 나머지 쓰레드는 정상 동작한다.

### 요청마다 쓰레드 생성시의 단점

- 클라이언트로부터 요청이 들어올때마다 쓰레드를 새롭게 생성하는 것은 비싼작업이다. 즉, 요청마다 쓰레드를 새로 생성하는것 자체가 시간이 오래걸리므로 응답속도가 늦춰진다.
- 쓰레드는 컨텍스트 스위칭 비용이 발생한다.(cpu코어는 한번에 하나의 쓰레드만 관리하는데 하나의 쓰레드 사용하고 다른 쓰레드를 사용하는 switching하는 비용이 는다는 의미이다.)
- 요청마다 쓰레드를 생성하므로 쓰레드 생성에 제한이없다.(너무 많은 요청이 들어오면 CPU, 메모리 임계점을 넘어서 서버가 죽어버릴수도있음)

## 쓰레드 풀!

- 요청이 들어오면 이미 존재하는 쓰레드를 가져다 사용했다가 다시 거기로 반납하는 과정이다.
- 쓰레드 풀에 이미 여러 쓰레드가 존재하고 요청이들어오면 쓰레드 풀에서 쓰레드 하나를 가져와서 사용한다음 요청에 대한 처리가 끝나면 다시 쓰레드 풀로 사용한 쓰레드를 반납하는 과정이다.

- 얼핏보기엔 요청마다 쓰레드 생성과 다른게 없어보이지만 요청들어올 때마다 새롭게 쓰레드를 생성하는 것과 다르게 이미 생성되어있는 쓰레드를 사용하는 것이므로 쓰레드 생성 비용을 줄일수 있고 쓰레드 생성에 제한을 두어 서버가 죽는걸 방지할수도 있고 쓰레드 풀의 쓰레드가 다 사용중이면 이 이후에 오는 요청에 대해서 개발자가 설정을 통해서 바로 거절하거나 대기시키거나 지정할수있다.

### 쓰레드 풀의 특징

- 필요한 쓰레드를 쓰레드 풀에서 관리한다.(미리 쓰레드를 생성해서 쓰레드 풀에서 관리중)
- 쓰레드 풀에 생성 가능한 쓰레드의 최대치를 관리한다. 톰캣은 기본설정으로 200개의 쓰레드를 쓰레드 풀에서관리(이는 개발자가 자신의 어플의 성능에 따라 설정가능) -> 이 특징의 장점은 최대치를 관리함으로써 서버가 죽는걸 방지할수있겠지? 요청마다 쓰레드 생성하는 것과다르게 제한을 두는거닌까.

### 쓰레드풀 사용과정

- 쓰레드가 필요하면 쓰레드풀에 이미 존재하는 쓰레드를 꺼내서 사용.
- 요청 처리끝나서 사용종료되면 쓰레드풀에 다시 쓰레드를 반납
- 최대 쓰레드가 모두 사용중이라 쓰레드풀에 남는쓰레드가 없으면 기다리는 요청은 대기하거나 바로 거절할수있는 설정을 개발자가 할수있음

### 장점! (계속 얘기했지만 다시)

- 쓰레드가 쓰레드풀에 미리 생성이 되어있으므로 쓰레드를 생성하고 종료하는 비용을 절약할수있어서 요청에대한 응답 시간을 단축시킬수있음
- 생성 가능한 쓰레드의 수가 제한이 되어있으므로 너무많은 요청이들어와도 서버단에 이미 들어와있는 요청에 대해선 안전하게 처리할수있음(물론 제한넘어선 요청에 대해선 클라이언트단에서 서버로 요청못하고 있겠따.!)

### 실무 팁

- WAS의 주요 튜닝 포인트는 최대 쓰레드 수이다!(쓰레드 풀에서 관리할수있는 쓰레드 수)
- 이값을 너무 낮게 설정하면 서버에서 사용할수있는 CPU보다 너무 조금사용해서 낭비를 할수있고 클라이언트에서 요청이 증가하면 조금의 요청에 대해서도 클라이언트는 요청을 기다리고있을수있다.
- 쓰레드풀의 쓰레드수를 너무 높게 설정하면 상상이상으로 많은 요청이들어오면 서버단에서 임계점을 버티지못하고 서버자체가 죽어버릴수도 있다.(요청마다 쓰레드 생성할때와 같은 문제가 일어날수있다.)

# WAS(Web Application Server)의 멀티 쓰레드 지원 - 핵심!!

- 멀티 쓰레드에 대한 부분은 WAS가 알아서 처리한다.
- 개발자는 멀티쓰레드 신경안써도됨.
- 개발자는 마치 싱글쓰레드 프로그래밍을 하듯이 편하게 소스코드 개발할수있다.
- 그래도 멀티쓰레드 환경이긴 하므로 공유변수(싱글톤 객체로 관리되는 스프링빈, 서블릿 객체)의 사용을 주의해야한다. - 이것만 좀 신경쓰면됨!
